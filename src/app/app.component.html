<router-outlet></router-outlet>

<div class="dashboard">
  <div class="dashboard-header">
    <div class="left-brand">
      <img src="assets/logo.png" alt="Logo" class="logo-img" />
      <h2 class="dashboard-title">Smart Factory</h2>
    </div>
    <div class="right-placeholder"></div>
  </div>

  <div class="main-section">
    <div class="left-section">
      <div class="circular-layout">
        <!-- CNC Turning Machine -->
        <div class="machine-card top-left-card">
          <div class="machine-card-inner">
            <div class="machine-icon">
              <img src="assets/CNC.png" alt="CNC">
            </div>
            <h3 class="machine-title">CNC Machine</h3>
            <div class="machine-status">
              <span class="status-dot" [ngClass]="{
                'running': cncTurning.status === 'Running',
                'idle': cncTurning.status === 'Idle',
                'stopped': cncTurning.status === 'Stop' || cncTurning.status === 'Stopped'
              }"></span>
              <span class="status-label">Status: 
                <span class="status-value" [ngClass]="{
                  'running-value': cncTurning.status === 'Running',
                  'idle-value': cncTurning.status === 'Idle',
                  'stopped-value': cncTurning.status === 'Stop' || cncTurning.status === 'Stopped'
                }">
                  {{ cncTurning.status }}
                </span>
              </span>
            </div>
            <div class="machine-part-no">Part No: P7979</div>
            <div class="machine-details" *ngIf="currentProducts['CNC Turning']">
              Processing: {{ currentProducts['CNC Turning']?.serial_no }}
            </div>
          </div>
        </div>

        <!-- Milling Machine -->
        <div class="machine-card top-right-card">
          <div class="machine-card-inner">
            <div class="machine-icon">
              <img src="assets/milling-machine.png" alt="Milling">
            </div>
            <h3 class="machine-title">Milling</h3>
            <div class="machine-status">
              <span class="status-dot" [ngClass]="{
                'running': milling.status === 'Running',
                'idle': milling.status === 'Idle',
                'stopped': milling.status === 'Stop' || milling.status === 'Stopped'
              }"></span>
              <span class="status-label">Status: 
                <span class="status-value" [ngClass]="{
                  'running-value': milling.status === 'Running',
                  'idle-value': milling.status === 'Idle',
                  'stopped-value': milling.status === 'Stop' || milling.status === 'Stopped'
                }">
                  {{ milling.status }}
                </span>
              </span>
            </div>
            <div class="machine-part-no">Part No: P09245</div>
            <div class="machine-details" *ngIf="currentProducts['Milling']">
              Processing: {{ currentProducts['Milling']?.serial_no }}
            </div>
          </div>
        </div>

        <!-- ASRS -->
        <div class="machine-card left-center-card">
          <div class="machine-card-inner asrs-card">
            <div class="machine-icon">
              <img src="assets/asrs.jfif" alt="ASRS">
            </div>
            <h3 class="machine-title">ASRS</h3>
            <div class="slot-grid">
              <div *ngFor="let slot of slots" class="slot-box"
                [ngClass]="{
                  'processing': slot.status === 'Processing',
                  'empty': slot.status === 'Empty',
                  'returned-good': slot.status === 'Returned-Good' || (slot.status === 'Filled' && slot.final_status === 'Good')
                }">
                {{ slot.slot_number }}
                <div *ngIf="slot.serial_no" class="slot-serial">
                  {{ slot.serial_no }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Manual QC -->
        <div class="machine-card right-center-card">
          <div class="machine-card-inner-right">
            <div class="machine-icon">
              <img src="assets/manual-QC.png" alt="Manual QC">
            </div>
            <h3 class="machine-title">Manual QC</h3>
            <div class="machine-status">
              <span class="status-dot" [ngClass]="{
                'running': manualQC.status === 'Running',
                'idle': manualQC.status === 'Idle',
                'stopped': manualQC.status === 'Stop' || manualQC.status === 'Stopped'
              }"></span>
              <span class="status-label">Status: 
                <span class="status-value" [ngClass]="{
                  'running-value': manualQC.status === 'Running',
                  'idle-value': manualQC.status === 'Idle',
                  'stopped-value': manualQC.status === 'Stop' || manualQC.status === 'Stopped'
                }">
                  {{ manualQC.status }}
                </span>
              </span>
            </div>
            <div class="machine-part-no">Part No: P10803</div>
            <div class="machine-details" *ngIf="currentProducts['Manual QC']">
              Processing: {{ currentProducts['Manual QC']?.serial_no }}
            </div>
          </div>
        </div>

        <!-- Visual Inspection -->
        <div class="machine-card bottom-left-card">
          <div class="machine-card-inner">
            <div class="machine-icon">
              <img src="assets/visual-ins.png" alt="Visual Inspection">
            </div>
            <h3 class="machine-title">Visual Inspection</h3>
            <div class="machine-status">
              <span class="status-dot" [ngClass]="{
                'running': visualInspection.status === 'Running',
                'idle': visualInspection.status === 'Idle',
                'stopped': visualInspection.status === 'Stop' || visualInspection.status === 'Stopped'
              }"></span>
              <span class="status-label">Status: 
                <span class="status-value" [ngClass]="{
                  'running-value': visualInspection.status === 'Running',
                  'idle-value': visualInspection.status === 'Idle',
                  'stopped-value': visualInspection.status === 'Stop' || visualInspection.status === 'Stopped'
                }">
                  {{ visualInspection.status }}
                </span>
              </span>
            </div>
            <div class="machine-part-no">Part No: P09125</div>
            <div class="machine-details" *ngIf="currentProducts['Visual Inspection']">
              Processing: {{ currentProducts['Visual Inspection']?.serial_no }}
            </div>
          </div>
        </div>

        <!-- Assembly -->
        <div class="machine-card bottom-right-card">
          <div class="machine-card-inner">
            <div class="machine-icon">
              <img src="assets/manufacturing.png" alt="Assembly">
            </div>
            <h3 class="machine-title">Assembly</h3>
            <div class="machine-status">
              <span class="status-dot" [ngClass]="{
                'running': assembly.status === 'Running',
                'idle': assembly.status === 'Idle',
                'stopped': assembly.status === 'Stop' || assembly.status === 'Stopped'
              }"></span>
              <span class="status-label">Status: 
                <span class="status-value" [ngClass]="{
                  'running-value': assembly.status === 'Running',
                  'idle-value': assembly.status === 'Idle',
                  'stopped-value': assembly.status === 'Stop' || assembly.status === 'Stopped'
                }">
                  {{ assembly.status }}
                </span>
              </span>
            </div>
            <div class="machine-part-no">Part No: Robot Leon</div>
            <div class="machine-details" *ngIf="currentProducts['Assembly']">
              Processing: {{ currentProducts['Assembly']?.serial_no }}
            </div>
          </div>
        </div>

        <!-- AMR in center -->
        <div class="amr-container">
          <!-- Static AMR in center when not moving -->
          <div *ngIf="!isAnimating" class="amr-center">
            <img src="assets/amr-2.png" alt="AMR" class="amr-image"/>
            <div *ngIf="amr">
              {{ amr.action_type }} {{ amr.serial_no }} from {{ amr.from_location }} to {{ amr.to_location }} ({{ amr.status }})
            </div>
          </div>
          
          <!-- Animated AMR when moving -->
          <div *ngIf="isAnimating" class="amr-animated" 
              [ngStyle]="{
                'left': amrPosition.x + '%',
                'top': amrPosition.y + '%',
                'transform': 'translate(-50%, -50%) rotate(' + amrRotation + 'deg)'
              }">
            <img src="assets/amr-2.png" alt="AMR" class="amr-image"/>
            <div class="amr-status">
              {{ amr?.action_type }} {{ amr?.serial_no }} 
              <span class="moving-indicator">Moving...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
   
    <!-- Right Section with API Data Integration -->
    <div class="right-section">
      <nz-card class="stat-card">
        <div class="icon-container">
          <i nz-icon nzType="database" nzTheme="outline"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ oeePercentage }}%</div>
          <div class="stat-label">OEE</div>
          <div class="oee-progress-container">
            <div class="oee-progress-bar">
              <div class="oee-progress-fill" [style.width]="oeePercentage + '%'"></div>
            </div>
            <div class="oee-progress-labels">
              <span>0%</span>
              <span>100%</span>
            </div>
          </div>
        </div>
      </nz-card>

      <nz-card class="stat-card">
        <div class="icon-container">
          <i nz-icon nzType="car" nzTheme="outline"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ totalProduction }}</div>
          <div class="stat-label">Total Production</div>
        </div>
      </nz-card>

      <nz-card class="stat-card">
        <div class="icon-container">
          <i nz-icon nzType="check-circle" nzTheme="outline"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ goodProducts }}</div>
          <div class="stat-label-good">Good</div>
        </div>
      </nz-card>

      <nz-card class="stat-card">
        <div class="icon-container">
          <i nz-icon nzType="close-circle" nzTheme="outline"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ rejections }}</div>
          <div class="stat-label-rejection">Rejections</div>
        </div>
      </nz-card>

      <nz-card class="chart-card">
        <div class="chart-container">
          <highcharts-chart 
            [Highcharts]="Highcharts"
            [options]="pieChartOptions"
            style="display: block;"
            *ngIf="pieChartOptions.series">
          </highcharts-chart>
        </div>
      </nz-card>
    </div>
  </div>

  <div class="recent-activities">
    <div class="table-header">
      <h2>Recent Activities</h2>
      <div class="table-actions">
        <button nz-button nzType="default" class="action-btn">
          <i nz-icon nzType="filter" nzTheme="outline"></i>Filter
        </button>
      </div>
    </div>

    <nz-table
      #activitiesTable
      [nzData]="productHistoryData"
      [nzShowPagination]="false"
      [nzPageSize]="10">
      <thead>
        <tr>
          <th>S.No</th>
          <th>Serial No</th>
          <th>Material</th>
          <th>CNC</th>
          <th>Milling</th>
          <th>Assembly</th>
          <th>Manual QC</th>
          <th>Visual Inspection</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of activitiesTable.data; let i = index">
          <td>{{ i + 1 }}</td>
          <td>{{ data.serial_no }}</td>
          <td>{{ data.material_id }}</td>
          <td>{{ data.cnc_time }}</td>
          <td>{{ data.milling_time }}</td>
          <td>{{ data.assembly_time }}</td>
          <td>{{ data.manual_qc_time }}</td>
          <td>{{ data.visual_inspection_time }}</td>
          <td>
            <span class="status" [ngClass]="{
              'status-good': data.status === 'Good',
              'status-rejected': data.status === 'Rejected',
              'status-in-progress': data.status === 'In Progress'
            }">
              {{ data.status }}
            </span>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </div>
</div>